// src/screens/HomeScreen.tsx
import React from "react";
import { View, Text, Image, StyleSheet, ScrollView, Platform, useWindowDimensions, Dimensions } from "react-native";
import { useAuth } from "../context/AuthContext";
import { useFetchMoodCount, useFetchReminderCount } from "../api/hooks";
import Layout from "../components/UI/layout";
import { useTheme } from "../context/ThemeContext";
import { useNavigation } from "@react-navigation/native";
//import Logo from "../images/Meditating_logo.png";
import Logo from "../images/MeditatingLogoTransparent.png";
import type { NativeStackNavigationProp } from "@react-navigation/native-stack";
import { RootStackParamList } from "../navigation/AppNavigator";
import { SPACING, TYPOGRAPHY } from "../constants/styles";

const { width: SCREEN_WIDTH } = Dimensions.get('window');
const isIPad = Platform.OS === 'ios' && SCREEN_WIDTH >= 768;



//console.log('Platform.isPad:', Platform.isPad)
const HomeScreen = () => {
  const { token } = useAuth();
  const { colors } = useTheme();
  const navigation = useNavigation<NativeStackNavigationProp<RootStackParamList>>();

  const { data: moodCount = 0, isLoading: moodLoading } = useFetchMoodCount(token);
  const { data: reminderCount = 0, isLoading: reminderLoading } = useFetchReminderCount(token);
  const { width } = useWindowDimensions();
  //console.log('DEBUG:', { isIPad, OS: Platform.OS, isPad: Platform.isPad, width });

  const useGrid = (Platform.OS === "web" && width > 600) || isIPad;
  console.log('isIPad:', isIPad, 'useGrid:', useGrid);

  

  const cards = [
    { key: "chat", title: "Chat", subtitle: "Start a conversation" },
    { key: "mood", title: "Mood", subtitle: moodLoading ? "Loading..." : `${moodCount} mood logs this week` },
    { key: "journal", title: "Journal", subtitle: "Write a new entry" },
    { key: "activities", title: "Activities", subtitle: "Explore exercises" },
    { key: "reminders", title: "Reminders", subtitle: reminderLoading ? "Loading..." : `${reminderCount} today` },
    { key: "resources", title: "Resources", subtitle: " Recommended  Resources" },
    { key: "progressdashboard", title: "Progress", subtitle: "Your progress stats"},

  ];

  return (
    <Layout title="Home" onNavigate={(screen) => navigation.navigate(screen as never)}>
      <ScrollView
        style={{ flex: 1, backgroundColor: colors.background }}
        contentContainerStyle={{
          paddingHorizontal: isIPad ? SPACING.xl : SPACING.md,
          paddingTop: SPACING.md,
          paddingBottom: SPACING.md,
        }}
        showsVerticalScrollIndicator={false}
      >
        {/* Header */}
        <Text style={[styles.date, { color: colors.subText }]}>
          {new Date().toLocaleDateString("en-US", {
            weekday: "long",
            month: "long",
            day: "numeric",
          })}
        </Text>
        <Text style={[styles.welcome, { color: colors.text }]}>
          Welcome, how are you feeling today?
        </Text>
        <Image source={Logo} style={styles.logo} resizeMode="contain" />
        <Text style={{fontSize: 20, color: 'red'}}>
        {`width: ${SCREEN_WIDTH} isIPad: ${isIPad}`}
        </Text>

        {/* Cards Grid */}
        <View style={useGrid ? styles.gridContainer : styles.listContainer}>
          {cards.map((item) => (
            <Layout.Card
              key={item.key}
              title={item.title}
              subtitle={item.subtitle}
              titleStyle={{fontSize: isIPad? 24 : 18}}
              subtitleStyle={{ fontSize: isIPad ? 14 : 10 }}
              onPress={() => navigation.navigate(item.key as never)}
              testID={`home_card_${item.key}`}
              titleColor="#FFFFFF"
              subtitleColor="#FFFFFF"
              style={{
                width: useGrid ? "47%" : "90%",
                aspectRatio: isIPad ? 2.8 : useGrid ? 2 : 2.2,
                marginBottom: isIPad ? 20 : 16,
                justifyContent: "center",
                alignItems: "center",
                backgroundColor: colors.primary,
                borderRadius: 20,
                shadowColor: '#000',
                shadowOffset: { width: 0, height: 4 },
                shadowOpacity: 0.1,
                shadowRadius: 12,
                elevation: 4,
              }}
            />
          ))}
        </View>
      </ScrollView>
    </Layout>
  );
};


const styles = StyleSheet.create({
  date: {
    fontSize: isIPad ? TYPOGRAPHY.sizes.md : TYPOGRAPHY.sizes.sm,
    marginBottom: SPACING.md,
    textAlign: "center",
    fontWeight: '500',  //Add medium weight
  },
  welcome: {
    fontSize: isIPad ? 32 : TYPOGRAPHY.sizes.xl,
    fontWeight: TYPOGRAPHY.weights.bold,
    textAlign: "center",
    marginBottom: SPACING.lg,// Changed from lg -> more space
    letterSpacing: -0.5,  // ADD: Tighter letter spacing for elegance
  },
  logo: {
    width: isIPad ? 200 : 160,
    height: isIPad ? 200 : 160,
    marginBottom: SPACING.lg,
    alignSelf: "center",
  },
  gridContainer: {
    flexDirection: "row",
    flexWrap: "wrap",
    justifyContent: "space-between",
    maxWidth: isIPad ? 800 : undefined,   // ‚Üê constrains grid width on iPad
    alignSelf: "center",
    width: "100%",
  },
  listContainer: {
    alignItems: "center",
  },
});

export default HomeScreen;
